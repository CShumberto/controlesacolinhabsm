<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>CRUD Firebase Firestore com DataTables</title>
    <!-- Inclua os links para os estilos CSS e JavaScript necessários aqui -->

    <!-- Adicione os links para os estilos do DataTables e do Font Awesome (ícones) -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>
<body>
    <h1 class="mt-4">CRUD Firebase Firestore com DataTables</h1>

    <!-- Botão para adicionar um novo registro -->
    <button id="adicionarRegistro" class="btn btn-primary mt-3"><i class="fas fa-plus"></i> Adicionar Registro</button>

    <!-- Campos de filtro -->
    <div class="mt-3">
        <label for="filtroNumeroLoja">Filtrar por Número da Loja:</label>
        <input type="text" id="filtroNumeroLoja" class="form-control">
    </div>

    <!-- Tabela para exibir os dados -->
    <table id="tabelaDados" class="table mt-4">
        <thead>
            <tr>
                <th>Dia</th>
                <th>Número da Loja</th>
                <th>Nome do Operador</th>
                <th>TOTAL Easy Open Bag G</th>
                <th>TOTAL Planeta Agradece P</th>
                <th>Venda total mensal (R$)</th>
                <th>Total de Sacolinhas (UN)</th>
                <th>Valor total sacolinha G (R$)</th>
                <th>Valor total sacolinha P (R$)</th>
                <th>Valor Total sacolinha (R$)</th>
                <th>% Faturamento</th>
                <th>Observação</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            <!-- Os dados serão carregados aqui dinamicamente -->
        </tbody>
    </table>

    <!-- Modal para adicionar/editar registro -->
    <div class="modal fade" id="modalRegistro" tabindex="-1" role="dialog" aria-labelledby="modalRegistroLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalRegistroLabel">Adicionar Registro</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Formulário de adição/editação de registro -->
                    <form id="formularioRegistro">
                        <!-- ... (campos do formulário existentes) ... -->
                    </form>
                    <!-- Div de carregamento (inicialmente oculta) -->
                    <div id="carregamento" class="text-center" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i> Aguarde...
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" id="salvarRegistro">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Inclua os links para as bibliotecas JavaScript necessárias aqui -->

    <!-- Adicione os scripts do jQuery, DataTables e Firebase Firestore -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>

    <script>
        // Configurações do Firebase (substitua pelos seus próprios dados)
        var firebaseConfig = {
           apiKey: "AIzaSyC28CYNjHhUi8rOwrASXdRJ1cm2PV6fEW4",
    authDomain: "controlemensal-sacolinhas.firebaseapp.com",
    databaseURL: "https://controlemensal-sacolinhas-default-rtdb.firebaseio.com",
    projectId: "controlemensal-sacolinhas",
    storageBucket: "controlemensal-sacolinhas.appspot.com",
    messagingSenderId: "925424065013",
    appId: "1:925424065013:web:cf961586c6300ceb1468bc"
        };
        
        // Inicialize o Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Referência à coleção de dados Firestore
        var db = firebase.firestore();
        var dadosCollection = db.collection("dados");

        // Função para carregar os dados na tabela usando DataTables
        function carregarDados() {
            // Configurações do DataTables
            var tabela = $("#tabelaDados").DataTable({
                destroy: true, // Destruir a tabela existente antes de criar uma nova
                paging: true, // Ativar paginação
                searching: true, // Ativar pesquisa
                ordering: true, // Ativar ordenação
                responsive: true, // Tornar a tabela responsiva
                language: {
                    url: "https://cdn.datatables.net/plug-ins/1.10.25/i18n/Portuguese-Brasil.json" // Idioma da tabela
                },
                columnDefs: [
                    { orderable: false, targets: -1 } // Desativar ordenação para a última coluna (Ações)
                ]
            });

            // Limpar a tabela antes de recarregar os dados
            tabela.clear().draw();

            // Consultar os dados no Firestore e adicioná-los à tabela
            dadosCollection.get().then((querySnapshot) => {
                querySnapshot.forEach((doc) => {
                    var data = doc.data();
                    var docId = doc.id;

                    // Adicionar uma nova linha à tabela com os dados do documento
                    tabela.row.add([
                        data.Dia,
                        data['Número da Loja'],
                        data['Nome do Operador'],
                        data['TOTAL Easy Open Bag G'],
                        data['TOTAL Planeta Agradece P'],
                        data['Venda total mensal (R$)'],
                        data['Total de Sacolinhas (UN)'],
                        data['Valor total sacolinha G (R$)'],
                        data['Valor total sacolinha P (R$)'],
                        data['Valor Total sacolinha (R$)'],
                        data['% Faturamento'],
                        data.Observação,
                        `<button class="btn btn-warning btn-sm editar" data-doc-id="${docId}"><i class="fas fa-edit"></i> Editar</button>
                         <button class="btn btn-danger btn-sm excluir" data-doc-id="${docId}"><i class="fas fa-trash"></i> Excluir</button>`
                    ]).draw();
                });

                // Definir manipuladores de eventos para os botões de editar e excluir
                $(".editar").click(function () {
                    var docId = $(this).data("doc-id");
                    abrirModalEditar(docId);
                });

                $(".excluir").click(function () {
                    var docId = $(this).data("doc-id");
                    if (confirm("Tem certeza de que deseja excluir este registro?")) {
                        excluirRegistro(docId);
                    }
                });
            }).catch((error) => {
                console.error("Erro ao carregar dados:", error);
            });
        }

        // Função para abrir o modal de edição com os dados do registro
        function abrirModalEditar(docId) {
            mostrarCarregamento(); // Mostra o ícone de carregamento

            // Consultar o documento no Firestore
            dadosCollection.doc(docId).get().then((doc) => {
                if (doc.exists) {
                    var data = doc.data();
                    $("#modalRegistroLabel").text("Editar Registro");
                    $("#formularioRegistro").attr("data-doc-id", docId); // Define o atributo 'data-doc-id' no formulário
                    // Preencha os campos do formulário com os dados do documento
                    $("#dia").val(data.Dia);
                    $("#numeroLoja").val(data['Número da Loja']);
                    $("#nomeOperador").val(data['Nome do Operador']);
                    $("#totalEasyOpenBagG").val(data['TOTAL Easy Open Bag G']);
                    $("#totalPlanetaAgradeceP").val(data['TOTAL Planeta Agradece P']);
                    $("#vendaTotalMensal").val(data['Venda total mensal (R$)']);
                    $("#totalSacolinhasUN").val(data['Total de Sacolinhas (UN)']);
                    $("#valorSacolinhaG").val(data['Valor total sacolinha G (R$)']);
                    $("#valorSacolinhaP").val(data['Valor total sacolinha P (R$)']);
                    $("#valorTotalSacolinha").val(data['Valor Total sacolinha (R$)']);
                    $("#percentualFaturamento").val(data['% Faturamento']);
                    $("#observacao").val(data.Observação);
                    // Abrir o modal de edição
                    $("#modalRegistro").modal("show");
                } else {
                    console.error("Registro não encontrado.");
                }
            }).catch((error) => {
                console.error("Erro ao abrir modal de edição:", error);
            }).finally(() => {
                ocultarCarregamento(); // Oculta o ícone de carregamento
            });
        }

        // Função para salvar um novo registro ou atualizar um registro existente
        function salvarRegistro() {
            mostrarCarregamento(); // Mostra o ícone de carregamento e desabilita os botões

            var docId = $("#formularioRegistro").attr("data-doc-id");
            var dia = $("#dia").val();
            var numeroLoja = $("#numeroLoja").val();
            var nomeOperador = $("#nomeOperador").val();
            var totalEasyOpenBagG = $("#totalEasyOpenBagG").val();
            var totalPlanetaAgradeceP = $("#totalPlanetaAgradeceP").val();
            var vendaTotalMensal = $("#vendaTotalMensal").val();
            var totalSacolinhasUN = $("#totalSacolinhasUN").val();
            var valorSacolinhaG = $("#valorSacolinhaG").val();
            var valorSacolinhaP = $("#valorSacolinhaP").val();
            var valorTotalSacolinha = $("#valorTotalSacolinha").val();
            var percentualFaturamento = $("#percentualFaturamento").val();
            var observacao = $("#observacao").val();

            // Verifique se todos os campos obrigatórios estão preenchidos
            if (
                dia &&
                numeroLoja &&
                nomeOperador &&
                totalEasyOpenBagG &&
                totalPlanetaAgradeceP &&
                vendaTotalMensal &&
                totalSacolinhasUN &&
                valorSacolinhaG &&
                valorSacolinhaP &&
                valorTotalSacolinha &&
                percentualFaturamento
            ) {
                // Dados a serem salvos no Firestore
                var dados = {
                    Dia: dia,
                    'Número da Loja': numeroLoja,
                    'Nome do Operador': nomeOperador,
                    'TOTAL Easy Open Bag G': totalEasyOpenBagG,
                    'TOTAL Planeta Agradece P': totalPlanetaAgradeceP,
                    'Venda total mensal (R$)': vendaTotalMensal,
                    'Total de Sacolinhas (UN)': totalSacolinhasUN,
                    'Valor total sacolinha G (R$)': valorSacolinhaG,
                    'Valor total sacolinha P (R$)': valorSacolinhaP,
                    'Valor Total sacolinha (R$)': valorTotalSacolinha,
                    '% Faturamento': percentualFaturamento,
                    Observação: observacao,
                };

                if (docId) {
                    // Atualizar um registro existente
                    dadosCollection.doc(docId).set(dados).then(() => {
                        alert("Registro atualizado com sucesso!");
                        $("#modalRegistro").modal("hide");
                        limparFormulario();
                        carregarDados();
                    }).catch((error) => {
                        console.error("Erro ao editar registro:", error);
                    }).finally(() => {
                        ocultarCarregamento(); // Oculta o ícone de carregamento e habilita os botões
                    });
                } else {
                    // Adicionar um novo registro
                    dadosCollection.add(dados).then(() => {
                        alert("Registro adicionado com sucesso!");
                        $("#modalRegistro").modal("hide");
                        limparFormulario();
                        carregarDados();
                    }).catch((error) => {
                        console.error("Erro ao adicionar registro:", error);
                    }).finally(() => {
                        ocultarCarregamento(); // Oculta o ícone de carregamento e habilita os botões
                    });
                }
            } else {
                alert("Preencha todos os campos obrigatórios.");
                ocultarCarregamento(); // Certifique-se de ocultar o ícone de carregamento mesmo em caso de erro
            }
        }

        // Função para excluir um registro
        function excluirRegistro(docId) {
            mostrarCarregamento(); // Mostra o ícone de carregamento e desabilita os botões

            dadosCollection.doc(docId).delete().then(() => {
                alert("Registro excluído com sucesso!");
                $("#modalRegistro").modal("hide");
                carregarDados();
            }).catch((error) => {
                console.error("Erro ao excluir registro:", error);
            }).finally(() => {
                ocultarCarregamento(); // Oculta o ícone de carregamento e habilita os botões
            });
        }

        // Função para mostrar o ícone de carregamento e desabilitar os botões
        function mostrarCarregamento() {
            $("#carregamento").show();
            $("#salvarRegistro").prop("disabled", true);
            $("#fecharModal").prop("disabled", true);
        }

        // Função para ocultar o ícone de carregamento e habilitar os botões
        function ocultarCarregamento() {
            $("#carregamento").hide();
            $("#salvarRegistro").prop("disabled", false);
            $("#fecharModal").prop("disabled", false);
        }

        // Função para limpar o formulário
        function limparFormulario() {
            $("#formularioRegistro")[0].reset();
            $("#formularioRegistro").removeAttr("data-doc-id");
            $("#modalRegistroLabel").text("Adicionar Registro");
        }

        $(document).ready(function () {
            // Inicializar DataTables e carregar dados
            carregarDados();

            // Configurar evento de clique no botão "Adicionar Registro"
            $("#adicionarRegistro").click(function () {
                limparFormulario();
                $("#modalRegistro").modal("show");
            });

            // Configurar evento de clique no botão "Salvar"
            $("#salvarRegistro").click(function () {
                salvarRegistro();
            });

            // Configurar evento de digitação no campo de filtro por número de loja
            $("#filtroNumeroLoja").on("input", function () {
                var filtro = $(this).val();
                $("#tabelaDados").DataTable().column(1).search(filtro).draw();
            });
        });
    </script>
</body>
</html>
