<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>CRUD Firebase Firestore com DataTables</title>

    <!-- CSS do DataTables -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">

    <!-- Firebase Authentication -->
    <script src="https://www.gstatic.com/firebasejs/9.6.6/firebase-auth-compat.js"></script>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- JavaScript do DataTables -->
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.6/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.6/firebase-firestore-compat.js"></script>

    <!-- Bootstrap CSS e JS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- Ícones FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.0/css/all.min.css">

    <!-- Datepicker -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/locales/bootstrap-datepicker.pt-BR.min.js"></script>

    <style>
        /* Estilos personalizados para a tabela */
        .dataTables_wrapper {
            padding: 0; /* Remova o preenchimento */
            margin: 0; /* Remova as margens */
        }
    </style>
</head>
<body>
    <!-- Navbar com fundo azul -->
    <nav class="navbar navbar-expand-lg navbar-light bg-info">
        <div class="container">
            <!-- Título do Navbar -->
            <a class="navbar-brand" href="#">CRUD Firebase Firestore</a>

            <!-- Botão de alternância para dispositivos móveis -->
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Itens do Navbar -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <!-- Item "Requisição Sacola" -->
                    <li class="nav-item">
                        <a class="nav-link" href="#">Requisição Sacola</a>
                    </li>

                    <!-- Item "Lançar Sacola" -->
                    <li class="nav-item">
                        <a class="nav-link" href="#">Lançar Sacola</a>
                    </li>

                    <!-- Item "Cadastrar Operador" -->
                    <li class="nav-item">
                        <a class="nav-link" href="#">Cadastrar Operador</a>
                    </li>

                    <!-- Item "Dashboard" -->
                    <li class="nav-item">
                        <a class="nav-link" href="#">Dashboard</a>
                    </li>

                    <!-- Item "Sobre" -->
                    <li class="nav-item">
                        <a class="nav-link" href="#">Sobre</a>
                    </li>
                </ul>
            </div>

            <!-- Exibir email do usuário logado -->
            <span class="navbar-text">
                Usuário: <span id="userEmail">carregando...</span>
            </span>
            
            <!-- Botão "Sair" com estilo Bootstrap -->
            <button class="btn btn-danger ml-2" id="btnSair">Sair</button>
        </div>
    </nav>

    <h1 class="mt-4">CRUD Firebase Firestore com DataTables</h1>

    <!-- Botão para adicionar um novo registro -->
    <button id="adicionarRegistro" class="btn btn-primary mt-3"><i class="fas fa-plus"></i> Adicionar Registro</button>
    
    <!-- Campos de filtro -->
    <div class="row mb-3">
        <div class="col-md-4">
            <label for="filtroLoja">Filtrar por Loja:</label>
            <select class="form-select" id="filtroLoja" onchange="filtrarPorLoja()">
                <option value="">Todas as Lojas</option>
                <option value="Loja A">Loja A</option>
                <option value="Loja B">Loja B</option>
                <option value="Loja C">Loja C</option>
            </select>
        </div>
        <div class="col-md-4">
            <label for="filtroStatus">Filtrar por Status:</label>
            <select class="form-select" id="filtroStatus" onchange="filtrarPorStatus()">
                <option value="">Todos os Status</option>
                <option value="Pendente">Pendente</option>
                <option value="Aprovado">Aprovado</option>
                <option value="Entregue">Entregue</option>
            </select>
        </div>
        <div class="col-md-4">
            <label for="filtroData">Filtrar por Data:</label>
            <input type="text" class="form-control" id="filtroData" placeholder="Selecione uma data">
        </div>
    </div>

    <!-- Tabela de dados -->
    <table id="tabelaRegistros" class="table table-bordered">
        <thead>
            <tr>
                <th>ID</th>
                <th>Loja</th>
                <th>Descrição</th>
                <th>Status</th>
                <th>Data</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            <!-- Os dados da tabela serão preenchidos dinamicamente aqui -->
        </tbody>
    </table>

    <!-- Formulário de edição/adição de registros -->
    <div class="modal fade" id="modalRegistro" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Editar Registro</h5>
                    <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formularioRegistro">
                        <div class="mb-3">
                            <label for="inputLoja" class="form-label">Loja:</label>
                            <input type="text" class="form-control" id="inputLoja" required>
                        </div>
                        <div class="mb-3">
                            <label for="inputDescricao" class="form-label">Descrição:</label>
                            <input type="text" class="form-control" id="inputDescricao" required>
                        </div>
                        <div class="mb-3">
                            <label for="inputStatus" class="form-label">Status:</label>
                            <select class="form-select" id="inputStatus" required>
                                <option value="Pendente">Pendente</option>
                                <option value="Aprovado">Aprovado</option>
                                <option value="Entregue">Entregue</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="inputData" class="form-label">Data:</label>
                            <input type="text" class="form-control" id="inputData" required>
                        </div>
                        <input type="hidden" id="registroId">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" id="salvarRegistro">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Inicializar o Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC28CYNjHhUi8rOwrASXdRJ1cm2PV6fEW4",
    authDomain: "controlemensal-sacolinhas.firebaseapp.com",
    databaseURL: "https://controlemensal-sacolinhas-default-rtdb.firebaseio.com",
    projectId: "controlemensal-sacolinhas",
    storageBucket: "controlemensal-sacolinhas.appspot.com",
    messagingSenderId: "925424065013",
    appId: "1:925424065013:web:cf961586c6300ceb1468bc"
        };

        firebase.initializeApp(firebaseConfig);

        // Função para verificar o usuário logado
        function verificarUsuario() {
            const user = firebase.auth().currentUser;
            if (user) {
                // Usuário está logado
                document.getElementById("userEmail").textContent = user.email;
            } else {
                // Usuário não está logado, redirecionar para a página de login
                window.location.href = "index.html";
            }
        }

        // Evento de clique no botão "Sair"
        document.getElementById("btnSair").addEventListener("click", function() {
            firebase.auth().signOut().then(function() {
                // Redirecionar para index.html após sair
                window.location.href = "index.html";
            }).catch(function(error) {
                console.error("Erro ao sair:", error);
            });
        });

        // Função para inicializar o DataTable
        function inicializarDataTable() {
            $('#tabelaRegistros').DataTable({
                "language": {
                    "url": "https://cdn.datatables.net/plug-ins/9dcbecd42ad/i18n/Portuguese.json"
                }
            });
        }

        // Função para preencher a tabela com dados do Firestore
        function preencherTabela() {
            // Obtenha a referência para a coleção no Firestore (substitua "suaColecao" pelo nome da sua coleção)
            const db = firebase.firestore();
            const registrosRef = db.collection("suaColecao");

            // Limpe a tabela antes de preencher novamente
            $('#tabelaRegistros tbody').empty();

            // Consulta os registros no Firestore
            registrosRef.get().then((querySnapshot) => {
                querySnapshot.forEach((doc) => {
                    const registro = doc.data();
                    const dataFormatada = new Date(registro.data.toDate()).toLocaleDateString();

                    // Crie uma nova linha na tabela com os dados do registro
                    const newRow = `<tr>
                        <td>${doc.id}</td>
                        <td>${registro.loja}</td>
                        <td>${registro.descricao}</td>
                        <td>${registro.status}</td>
                        <td>${dataFormatada}</td>
                        <td>
                            <button class="btn btn-sm btn-warning editarRegistro" data-id="${doc.id}">Editar</button>
                            <button class="btn btn-sm btn-danger excluirRegistro" data-id="${doc.id}">Excluir</button>
                        </td>
                    </tr>`;

                    $('#tabelaRegistros tbody').append(newRow);
                });

                // Inicialize novamente o DataTable
                inicializarDataTable();
            }).catch((error) => {
                console.error("Erro ao obter registros:", error);
            });
        }

        // Evento de clique no botão "Adicionar Registro"
        document.getElementById("adicionarRegistro").addEventListener("click", function() {
            // Limpe o formulário
            document.getElementById("formularioRegistro").reset();
            // Limpe o campo de ID oculto
            document.getElementById("registroId").value = "";
            // Abra o modal
            $('#modalRegistro').modal('show');
        });

        // Evento de clique no botão "Salvar Registro"
        document.getElementById("salvarRegistro").addEventListener("click", function() {
            const db = firebase.firestore();
            const registrosRef = db.collection("suaColecao");

            // Obtenha os valores do formulário
            const loja = document.getElementById("inputLoja").value;
            const descricao = document.getElementById("inputDescricao").value;
            const status = document.getElementById("inputStatus").value;
            const data = new Date(document.getElementById("inputData").value);

            // Obtenha o valor do campo ID oculto
            const registroId = document.getElementById("registroId").value;

            // Dados do registro a serem salvos no Firestore
            const registro = {
                loja,
                descricao,
                status,
                data
            };

            // Se o registroId não estiver vazio, atualize um registro existente
            if (registroId) {
                registrosRef.doc(registroId).update(registro).then(() => {
                    // Feche o modal após atualizar
                    $('#modalRegistro').modal('hide');
                    // Atualize a tabela
                    preencherTabela();
                }).catch((error) => {
                    console.error("Erro ao atualizar registro:", error);
                });
            } else {
                // Caso contrário, adicione um novo registro
                registrosRef.add(registro).then(() => {
                    // Feche o modal após adicionar
                    $('#modalRegistro').modal('hide');
                    // Atualize a tabela
                    preencherTabela();
                }).catch((error) => {
                    console.error("Erro ao adicionar registro:", error);
                });
            }
        });

        // Evento de clique no botão "Editar" em uma linha da tabela
        $('#tabelaRegistros tbody').on('click', '.editarRegistro', function() {
            const db = firebase.firestore();
            const registrosRef = db.collection("suaColecao");

            const registroId = $(this).data("id");

            // Consulte o registro no Firestore com base no ID
            registrosRef.doc(registroId).get().then((doc) => {
                if (doc.exists) {
                    const registro = doc.data();

                    // Preencha o formulário com os dados do registro
                    document.getElementById("inputLoja").value = registro.loja;
                    document.getElementById("inputDescricao").value = registro.descricao;
                    document.getElementById("inputStatus").value = registro.status;
                    const dataFormatada = new Date(registro.data.toDate()).toLocaleDateString();
                    document.getElementById("inputData").value = dataFormatada;

                    // Preencha o campo de ID oculto
                    document.getElementById("registroId").value = registroId;

                    // Abra o modal de edição
                    $('#modalRegistro').modal('show');
                } else {
                    console.error("Registro não encontrado");
                }
            }).catch((error) => {
                console.error("Erro ao obter registro:", error);
            });
        });

        // Evento de clique no botão "Excluir" em uma linha da tabela
        $('#tabelaRegistros tbody').on('click', '.excluirRegistro', function() {
            if (confirm("Deseja realmente excluir este registro?")) {
                const db = firebase.firestore();
                const registrosRef = db.collection("suaColecao");

                const registroId = $(this).data("id");

                // Exclua o registro no Firestore com base no ID
                registrosRef.doc(registroId).delete().then(() => {
                    // Atualize a tabela após excluir
                    preencherTabela();
                }).catch((error) => {
                    console.error("Erro ao excluir registro:", error);
                });
            }
        });

        // Função para filtrar a tabela por loja
        function filtrarPorLoja() {
            const filtroLoja = document.getElementById("filtroLoja").value;
            const table = $('#tabelaRegistros').DataTable();
            table.column(1).search(filtroLoja).draw();
        }

        // Função para filtrar a tabela por status
        function filtrarPorStatus() {
            const filtroStatus = document.getElementById("filtroStatus").value;
            const table = $('#tabelaRegistros').DataTable();
            table.column(3).search(filtroStatus).draw();
        }

        // Função para inicializar o Datepicker
        function inicializarDatepicker() {
            $('#filtroData').datepicker({
                format: 'dd/mm/yyyy',
                language: 'pt-BR',
                autoclose: true
            });
        }

        // Evento de alteração do campo de filtro de data
        $('#filtroData').on('change', function() {
            filtrarPorData();
        });

        // Função para filtrar a tabela por data
        function filtrarPorData() {
            const filtroData = document.getElementById("filtroData").value;
            const table = $('#tabelaRegistros').DataTable();
            table.column(4).search(filtroData).draw();
        }

        // Quando a página carrega, verifique o usuário logado e preencha a tabela
        verificarUsuario();
        preencherTabela();
        inicializarDatepicker();
    </script>
</body>
</html>
