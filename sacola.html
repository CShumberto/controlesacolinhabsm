<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>CRUD Firebase Firestore com DataTables</title>

    <!-- CSS do DataTables -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- JavaScript do DataTables -->
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.6/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.6/firebase-firestore-compat.js"></script>

    <!-- Bootstrap CSS e JS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- Ícones FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.0/css/all.min.css">

    <!-- Datepicker -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/locales/bootstrap-datepicker.pt-BR.min.js"></script>

    <style>
        /* Estilos personalizados para a tabela */
        .dataTables_wrapper {
            padding: 0; /* Remova o preenchimento */
            margin: 0; /* Remova as margens */
        }   
    </style>
</head>
<body>
    <h1 class="mt-4">CRUD Firebase Firestore com DataTables</h1>

    <!-- Botão para adicionar um novo registro -->
    <button id="adicionarRegistro" class="btn btn-primary mt-3"><i class="fas fa-plus"></i> Adicionar Registro</button>
    <!-- Campos de filtro -->
    <div class="row mb-3">
        <div class="col-md-4">
            <label for="filtroLoja">Filtrar por Loja:</label>
            <select class="form-select" id="filtroLoja" onchange="filtrarTabela()">
                <option value="">Todas as Lojas</option>
                <option value="1001">1001</option>
                <!-- Adicione aqui todas as opções de loja -->
            </select>
        </div>
        <div class="col-md-4">
            <label for="filtroOperador">Filtrar por Operador:</label>
            <input type="text" class="form-control" id="filtroOperador" onkeyup="filtrarTabela()">
        </div>
    </div>

    <script>
        // Função para filtrar a tabela com base nos campos "Operador" e "Loja"
        function filtrarTabela() {
            const filtroOperador = document.getElementById('filtroOperador').value.toLowerCase();
            const filtroLoja = document.getElementById('filtroLoja').value.toLowerCase();

            const tbody = document.querySelector('tbody');
            const linhas = tbody.getElementsByTagName('tr');

            // Iterar pelas linhas da tabela e mostrar/ocultar com base nos filtros
            for (let i = 0; i < linhas.length; i++) {
                const linha = linhas[i];
                const colunaOperador = linha.getElementsByTagName('td')[2];
                const colunaLoja = linha.getElementsByTagName('td')[1];

                if (colunaOperador && colunaLoja) {
                    const operador = colunaOperador.textContent.toLowerCase();
                    const loja = colunaLoja.textContent.toLowerCase();

                    // Verificar se a linha atende aos critérios de filtro
                    if (operador.includes(filtroOperador) && loja.includes(filtroLoja)) {
                        linha.style.display = '';
                    } else {
                        linha.style.display = 'none';
                    }
                }
            }
        }
    </script>
    <!-- Tabela de dados -->
    <table id="tabela-dados" class="display mt-3">
        <thead>
            <tr>
                <th>Dia</th>
                <th>Número da Loja</th>
                <th>Nome do Operador</th>
                <th>TOTAL Easy Open Bag G</th>
                <th>TOTAL Planeta Agradece P</th>
                <th>Venda total mensal (R$)</th>
                <th>Total de Sacolinhas (UN)</th>
                <th>Valor total sacolinha G (R$)</th>
                <th>Valor total sacolinha P (R$)</th>
                <th>Valor Total sacolinha (R$)</th>
                <th>% Faturamento</th>
                <th>Observação</th>
                <th>Editar</th>
                <th>Excluir</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Modal para adicionar/editar registro -->
    <div class="modal fade" id="modalRegistro" tabindex="-1" role="dialog" aria-labelledby="modalRegistroLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalRegistroLabel">Adicionar Registro</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Formulário de adição/editação de registro -->
                    <form id="formularioRegistro">
                        <input type="hidden" id="registroId">
                        <div class="form-group">
                            <label for="dia">Dia:</label>
                            <input type="date" class="form-control" id="dia" required>
                        </div>
                        <div class="form-group">
                            <label for="numeroLoja">Número da Loja:</label>
                            <input type="text" class="form-control" id="numeroLoja">
                        </div>
                        <div class="form-group">
                            <label for="nomeOperador">Nome do Operador:</label>
                            <input type="text" class="form-control" id="nomeOperador">
                        </div>
                        <div class="form-group">
                            <label for="totalEasyOpenBagG">TOTAL Easy Open Bag G:</label>
                            <input type="number" class="form-control" id="totalEasyOpenBagG" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="totalPlanetaAgradeceP">TOTAL Planeta Agradece P:</label>
                            <input type="number" class="form-control" id="totalPlanetaAgradeceP" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="vendaTotalMensal">Venda total mensal (R$):</label>
                            <input type="number" class="form-control" id="vendaTotalMensal" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="totalSacolinhas">Total de Sacolinhas (UN):</label>
                            <input type="number" class="form-control" id="totalSacolinhas" step="1">
                        </div>
                        <div class="form-group">
                            <label for="valorTotalSacolinhaG">Valor total sacolinha G (R$):</label>
                            <input type="number" class="form-control" id="valorTotalSacolinhaG" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="valorTotalSacolinhaP">Valor total sacolinha P (R$):</label>
                            <input type="number" class="form-control" id="valorTotalSacolinhaP" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="valorTotalSacolinha">Valor Total sacolinha (R$):</label>
                            <input type="number" class="form-control" id="valorTotalSacolinha" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="percentualFaturamento">% Faturamento:</label>
                            <input type="number" class="form-control" id="percentualFaturamento" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="observacao">Observação:</label>
                            <textarea class="form-control" id="observacao" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" id="salvarRegistro">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC28CYNjHhUi8rOwrASXdRJ1cm2PV6fEW4",
    authDomain: "controlemensal-sacolinhas.firebaseapp.com",
    databaseURL: "https://controlemensal-sacolinhas-default-rtdb.firebaseio.com",
    projectId: "controlemensal-sacolinhas",
    storageBucket: "controlemensal-sacolinhas.appspot.com",
    messagingSenderId: "925424065013",
    appId: "1:925424065013:web:cf961586c6300ceb1468bc"
        };

        // Inicializar o Firebase
        firebase.initializeApp(firebaseConfig);

        // Referência à coleção no Firestore
        const db = firebase.firestore();
        const dadosCollection = db.collection("dados");

        // Variáveis globais
        let tabela;

        // Função para limpar o formulário
        function limparFormulario() {
            document.getElementById('registroId').value = '';
            document.getElementById('dia').value = '';
            document.getElementById('numeroLoja').value = '';
            document.getElementById('nomeOperador').value = '';
            document.getElementById('totalEasyOpenBagG').value = '';
            document.getElementById('totalPlanetaAgradeceP').value = '';
            document.getElementById('vendaTotalMensal').value = '';
            document.getElementById('totalSacolinhas').value = '';
            document.getElementById('valorTotalSacolinhaG').value = '';
            document.getElementById('valorTotalSacolinhaP').value = '';
            document.getElementById('valorTotalSacolinha').value = '';
            document.getElementById('percentualFaturamento').value = '';
            document.getElementById('observacao').value = '';
        }

        // Função para adicionar um novo registro
        function adicionarRegistro() {
            const dia = document.getElementById('dia').value;
            const numeroLoja = document.getElementById('numeroLoja').value;
            const nomeOperador = document.getElementById('nomeOperador').value;

            if (dia && numeroLoja && nomeOperador) {
                dadosCollection.add({
                    dia: dia,
                    numeroLoja: numeroLoja,
                    nomeOperador: nomeOperador,
                    totalEasyOpenBagG: parseFloat(document.getElementById('totalEasyOpenBagG').value) || 0,
                    totalPlanetaAgradeceP: parseFloat(document.getElementById('totalPlanetaAgradeceP').value) || 0,
                    vendaTotalMensal: parseFloat(document.getElementById('vendaTotalMensal').value) || 0,
                    totalSacolinhas: parseInt(document.getElementById('totalSacolinhas').value) || 0,
                    valorTotalSacolinhaG: parseFloat(document.getElementById('valorTotalSacolinhaG').value) || 0,
                    valorTotalSacolinhaP: parseFloat(document.getElementById('valorTotalSacolinhaP').value) || 0,
                    valorTotalSacolinha: parseFloat(document.getElementById('valorTotalSacolinha').value) || 0,
                    percentualFaturamento: parseFloat(document.getElementById('percentualFaturamento').value) || 0,
                    observacao: document.getElementById('observacao').value
                }).then(() => {
                    alert("Registro adicionado com sucesso!");
                    $("#modalRegistro").modal("hide");
                    limparFormulario();
                    carregarDados();
                }).catch((error) => {
                    console.error("Erro ao adicionar registro:", error);
                });
            } else {
                alert("Preencha todos os campos obrigatórios.");
            }
        }

        // Função para excluir um registro
        function excluirRegistro(docId) {
            if (confirm("Tem certeza de que deseja excluir este registro?")) {
                dadosCollection.doc(docId).delete().then(() => {
                    alert("Registro excluído com sucesso!");
                    limparFormulario();
                    carregarDados();
                }).catch((error) => {
                    console.error("Erro ao excluir registro:", error);
                });
            }
        }

        // Função para carregar os dados na tabela
        function carregarDados() {
            dadosCollection.get().then((querySnapshot) => {
                const data = [];

                querySnapshot.forEach((doc) => {
                    const dados = doc.data();
                    data.push([
                        dados.dia,
                        dados.numeroLoja,
                        dados.nomeOperador,
                        dados.totalEasyOpenBagG,
                        dados.totalPlanetaAgradeceP,
                        dados.vendaTotalMensal,
                        dados.totalSacolinhas,
                        dados.valorTotalSacolinhaG,
                        dados.valorTotalSacolinhaP,
                        dados.valorTotalSacolinha,
                        dados.percentualFaturamento,
                        dados.observacao,
                        `<button class="btn btn-sm btn-warning" onclick="editarRegistro('${doc.id}')"><i class="fas fa-edit"></i> Editar</button>`,
                        `<button class="btn btn-sm btn-danger" onclick="excluirRegistro('${doc.id}')"><i class="fas fa-trash"></i> Excluir</button>`
                    ]);
                });

                if (tabela) {
                    tabela.destroy();
                }

                tabela = $('#tabela-dados').DataTable({
                    data: data,
                    columns: [
                        { title: "Dia" },
                        { title: "Número da Loja" },
                        { title: "Nome do Operador" },
                        { title: "TOTAL Easy Open Bag G" },
                        { title: "TOTAL Planeta Agradece P" },
                        { title: "Venda total mensal (R$)" },
                        { title: "Total de Sacolinhas (UN)" },
                        { title: "Valor total sacolinha G (R$)" },
                        { title: "Valor total sacolinha P (R$)" },
                        { title: "Valor Total sacolinha (R$)" },
                        { title: "% Faturamento" },
                        { title: "Observação" },
                        { title: "Editar", orderable: false },
                        { title: "Excluir", orderable: false }
                    ],
                    language: {
                        url: "//cdn.datatables.net/plug-ins/1.10.22/i18n/Portuguese-Brasil.json"
                    }
                });
            }).catch((error) => {
                console.error("Erro ao carregar dados:", error);
            });
        }

        // Função para editar um registro
        function editarRegistro(docId) {
            dadosCollection.doc(docId).get().then((doc) => {
                if (doc.exists) {
                    const dados = doc.data();

                    document.getElementById('registroId').value = doc.id;
                    document.getElementById('dia').value = dados.dia;
                    document.getElementById('numeroLoja').value = dados.numeroLoja;
                    document.getElementById('nomeOperador').value = dados.nomeOperador;
                    document.getElementById('totalEasyOpenBagG').value = dados.totalEasyOpenBagG;
                    document.getElementById('totalPlanetaAgradeceP').value = dados.totalPlanetaAgradeceP;
                    document.getElementById('vendaTotalMensal').value = dados.vendaTotalMensal;
                    document.getElementById('totalSacolinhas').value = dados.totalSacolinhas;
                    document.getElementById('valorTotalSacolinhaG').value = dados.valorTotalSacolinhaG;
                    document.getElementById('valorTotalSacolinhaP').value = dados.valorTotalSacolinhaP;
                    document.getElementById('valorTotalSacolinha').value = dados.valorTotalSacolinha;
                    document.getElementById('percentualFaturamento').value = dados.percentualFaturamento;
                    document.getElementById('observacao').value = dados.observacao;

                    $("#modalRegistro").modal("show");
                } else {
                    console.error("Registro não encontrado.");
                }
            }).catch((error) => {
                console.error("Erro ao buscar registro:", error);
            });
        }

        // Event listener para o botão "Salvar"
        document.getElementById('salvarRegistro').addEventListener('click', () => {
            const registroId = document.getElementById('registroId').value;

            if (registroId) {
                // Editar registro existente
                const dia = document.getElementById('dia').value;
                const numeroLoja = document.getElementById('numeroLoja').value;
                const nomeOperador = document.getElementById('nomeOperador').value;

                if (dia && numeroLoja && nomeOperador) {
                    dadosCollection.doc(registroId).update({
                        dia: dia,
                        numeroLoja: numeroLoja,
                        nomeOperador: nomeOperador,
                        totalEasyOpenBagG: parseFloat(document.getElementById('totalEasyOpenBagG').value) || 0,
                        totalPlanetaAgradeceP: parseFloat(document.getElementById('totalPlanetaAgradeceP').value) || 0,
                        vendaTotalMensal: parseFloat(document.getElementById('vendaTotalMensal').value) || 0,
                        totalSacolinhas: parseInt(document.getElementById('totalSacolinhas').value) || 0,
                        valorTotalSacolinhaG: parseFloat(document.getElementById('valorTotalSacolinhaG').value) || 0,
                        valorTotalSacolinhaP: parseFloat(document.getElementById('valorTotalSacolinhaP').value) || 0,
                        valorTotalSacolinha: parseFloat(document.getElementById('valorTotalSacolinha').value) || 0,
                        percentualFaturamento: parseFloat(document.getElementById('percentualFaturamento').value) || 0,
                        observacao: document.getElementById('observacao').value
                    }).then(() => {
                        alert("Registro atualizado com sucesso!");
                        $("#modalRegistro").modal("hide");
                        limparFormulario();
                        carregarDados();
                    }).catch((error) => {
                        console.error("Erro ao atualizar registro:", error);
                    });
                } else {
                    alert("Preencha todos os campos obrigatórios.");
                }
            } else {
                // Adicionar novo registro
                adicionarRegistro();
            }
        });

        // Event listener para o botão "Adicionar Registro"
        document.getElementById('adicionarRegistro').addEventListener('click', () => {
            limparFormulario();
            $("#modalRegistro").modal("show");
        });

        // Carregar os dados iniciais na tabela
        carregarDados();
    </script>
</body>
</html>
